<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #722ed1 0%, #9c5bd1 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 350px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    h2 {
      margin: 0 0 10px 0;
      font-size: 24px;
      font-weight: bold;
    }
    
    .subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      margin-bottom: 30px;
    }
    
    .code-display {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 2px;
    }
    
    #shareBtn {
      background: linear-gradient(45deg, #49aa19, #5cb85c);
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(73, 170, 25, 0.3);
    }
    
    #shareBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(73, 170, 25, 0.4);
    }
    
    #shareBtn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .loading {
      display: none;
      margin: 20px 0;
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .success-message {
      display: none;
      background: rgba(73, 170, 25, 0.2);
      color: #49aa19;
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      font-weight: bold;
    }
    
    .error-message {
      display: none;
      background: rgba(255, 69, 58, 0.2);
      color: #ff453a;
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      font-weight: bold;
    }
    
    .debug-info {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 12px;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üéÅ ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
    <p class="subtitle">‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ</p>
    
    <div class="code-display" id="referralCode">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
    </div>
    
    <button id="shareBtn" disabled>
      üöÄ ‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
    </button>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ä‡∏£‡πå...</p>
    </div>
    
    <div class="success-message" id="successMessage">
      ‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
    </div>
    
    <div class="error-message" id="errorMessage">
      ‚ùå ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
    </div>
    
    <!-- Debug Info -->
    <div class="debug-info" id="debugInfo">
      üîß Debug Information:<br>
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
    </div>
  </div>

  <script>
    function addDebugLog(message) {
      const debugInfo = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      debugInfo.innerHTML += `<br>[${timestamp}] ${message}`;
      debugInfo.scrollTop = debugInfo.scrollHeight;
      console.log(`[DEBUG] ${message}`);
    }

    async function main() {
      try {
        addDebugLog('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF App');
        
        // ‡∏î‡∏∂‡∏á LIFF config ‡∏à‡∏≤‡∏Å server
        addDebugLog('üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á config ‡∏à‡∏≤‡∏Å server...');
        const config = await fetch('/api/liff/config').then(r => r.json());
        
        addDebugLog(`üìã Config: ${JSON.stringify(config)}`);
        
        // Extract LIFF ID from LIFF_URL
        const liffId = config.liffUrl ? config.liffUrl.split('/').pop() : "YOUR_LIFF_ID_HERE";
        const botAddUrl = config.botAddUrl || "https://line.me/R/ti/p/@033mebpp";
        
        addDebugLog(`üÜî LIFF ID: ${liffId}`);
        addDebugLog(`ü§ñ Bot URL: ${botAddUrl}`);
        
        // Initialize LIFF
        addDebugLog('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Initialize LIFF...');
        await liff.init({ liffId: liffId });
        
        addDebugLog('‚úÖ LIFF initialized successfully');
        addDebugLog(`üì± LIFF ready: ${liff.isReady()}`);
        addDebugLog(`üë§ In client: ${liff.isInClient()}`);
        addDebugLog(`üîê Logged in: ${liff.isLoggedIn()}`);
        addDebugLog(`üåê Context: ${JSON.stringify(liff.getContext())}`);

        if (!liff.isLoggedIn()) {
          addDebugLog('üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á Login...');
          liff.login();
          return;
        }

        // Get referral code from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const referralCode = urlParams.get('code') || 'DEMO123';
        
        addDebugLog(`üéØ Referral Code: ${referralCode}`);
        
        // Display referral code
        document.getElementById('referralCode').textContent = referralCode;
        
        // Enable share button
        const shareBtn = document.getElementById('shareBtn');
        shareBtn.disabled = false;
        addDebugLog('‚úÖ Share button enabled');

        shareBtn.onclick = async () => {
          try {
            addDebugLog('üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå...');
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            shareBtn.disabled = true;
            
            // Hide previous messages
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // Check LIFF state before sharing
            addDebugLog(`üìä LIFF State Check:`);
            addDebugLog(`  - Ready: ${liff.isReady()}`);
            addDebugLog(`  - In Client: ${liff.isInClient()}`);
            addDebugLog(`  - Logged In: ${liff.isLoggedIn()}`);
            
            // Create share card
            addDebugLog('üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ä‡∏£‡πå...');
            const shareCard = createReferralShareCard(referralCode, botAddUrl);
            addDebugLog(`üìÑ Share Card Created: ${JSON.stringify(shareCard, null, 2).substring(0, 200)}...`);
            
            // Share using Share Target Picker
            addDebugLog('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å shareTargetPicker...');
            await liff.shareTargetPicker([shareCard]);
            
            addDebugLog('‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            
            // Show success
            document.getElementById('loading').style.display = 'none';
            document.getElementById('successMessage').style.display = 'block';
            
            // Auto close after 2 seconds
            setTimeout(() => {
              addDebugLog('üö™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á...');
              liff.closeWindow();
            }, 2000);
            
          } catch (err) {
            addDebugLog(`‚ùå Share Error: ${err.message}`);
            addDebugLog(`‚ùå Error Code: ${err.code || 'NO_CODE'}`);
            addDebugLog(`‚ùå Error Stack: ${err.stack || 'NO_STACK'}`);
            console.error('Detailed share error:', err);
            
            // Show error
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = `‚ùå ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`;
            shareBtn.disabled = false;
          }
        };

      } catch (error) {
        addDebugLog(`üí• LIFF Init Error: ${error.message}`);
        console.error('LIFF initialization failed:', error);
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
      }
    }

    function createReferralShareCard(referralCode, botAddUrl) {
      return {
        type: "flex",
        altText: `üéÅ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ! ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™ ${referralCode}`,
        contents: {
          type: "bubble",
          header: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    type: "text",
                    text: "üéÅ",
                    size: "xl",
                    color: "#ffffff",
                    flex: 0
                  },
                  {
                    type: "text",
                    text: "‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ!",
                    weight: "bold",
                    color: "#ffffff",
                    size: "lg",
                    flex: 4,
                    margin: "md"
                  }
                ]
              },
              {
                type: "text",
                text: "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏ó‡∏ô‡∏µ‡πâ",
                color: "#ffffff",
                size: "sm",
                align: "center",
                margin: "md"
              }
            ],
            backgroundColor: "#722ed1",
            paddingAll: "20px"
          },
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: "üî• ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©",
                    weight: "bold",
                    size: "md",
                    color: "#722ed1",
                    align: "center"
                  },
                  {
                    type: "text",
                    text: referralCode,
                    weight: "bold",
                    size: "xxl",
                    color: "#722ed1",
                    align: "center",
                    margin: "sm"
                  },
                  {
                    type: "text",
                    text: "‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏£‡∏´‡∏±‡∏™:" + referralCode,
                    size: "sm",
                    color: "#49aa19",
                    align: "center",
                    margin: "sm",
                    weight: "bold"
                  }
                ],
                spacing: "sm",
                margin: "lg",
                action: {
                  type: "clipboard",
                  clipboardText: "‡∏£‡∏´‡∏±‡∏™:" + referralCode
                }
              },
              {
                type: "separator",
                margin: "xl",
                color: "#303030"
              },
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: "üéØ ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:",
                    weight: "bold",
                    color: "#ffffff",
                    size: "sm"
                  },
                  {
                    type: "text",
                    text: "‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ 5 ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ\n‚úÖ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ 10 ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï\n‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ AI\n‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö AI-Auto Forex",
                    color: "#8c8c8c",
                    size: "xs",
                    wrap: true,
                    margin: "sm"
                  }
                ],
                margin: "lg"
              }
            ],
            spacing: "sm",
            paddingAll: "20px",
            backgroundColor: "#1f1f1f"
          },
          footer: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "button",
                style: "primary",
                action: {
                  type: "uri",
                  label: "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
                  uri: botAddUrl
                },
                color: "#722ed1",
                height: "md"
              },
              {
                type: "text",
                text: "‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß",
                color: "#d89614",
                size: "xs",
                align: "center",
                margin: "sm"
              }
            ],
            spacing: "sm",
            paddingAll: "20px",
            backgroundColor: "#1f1f1f"
          }
        }
      };
    }

    main();
  </script>
</body>
</html>