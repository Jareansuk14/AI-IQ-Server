<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #722ed1 0%, #9c5bd1 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 350px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    h2 {
      margin: 0 0 10px 0;
      font-size: 24px;
      font-weight: bold;
    }
    
    .subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      margin-bottom: 30px;
    }
    
    .code-display {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 2px;
    }
    
    #shareBtn {
      background: linear-gradient(45deg, #49aa19, #5cb85c);
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(73, 170, 25, 0.3);
    }
    
    #shareBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(73, 170, 25, 0.4);
    }
    
    #shareBtn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .loading {
      display: none;
      margin: 20px 0;
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .success-message {
      display: none;
      background: rgba(73, 170, 25, 0.2);
      color: #49aa19;
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      font-weight: bold;
    }
    
    .error-message {
      display: none;
      background: rgba(255, 69, 58, 0.2);
      color: #ff453a;
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      font-weight: bold;
    }
    
    .debug-info {
      display: none;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 10px;
      text-align: left;
      white-space: pre-wrap;
      max-height: 100px;
      overflow-y: auto;
    }
    
    .show-debug {
      display: block !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üéÅ ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
    <p class="subtitle">‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ</p>
    
    <div class="code-display" id="referralCode">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
    </div>
    
    <button id="shareBtn" disabled>
      üöÄ ‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
    </button>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ä‡∏£‡πå...</p>
    </div>
    
    <div class="success-message" id="successMessage">
      ‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
    </div>
    
    <div class="error-message" id="errorMessage">
      ‚ùå ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
    </div>
    
    <div class="debug-info" id="debugInfo">
      Debug information will appear here
    </div>
    
    <button onclick="toggleDebug()" style="margin-top: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 5px; font-size: 10px;">
      üêõ Toggle Debug
    </button>
  </div>

  <script>
    // ‡∏î‡∏∂‡∏á LIFF ID ‡∏à‡∏≤‡∏Å server ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL
    async function getLiffConfig() {
      try {
        // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL parameter ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debugging)
        const urlParams = new URLSearchParams(window.location.search);
        const urlLiffId = urlParams.get('liffId');
        if (urlLiffId) {
          console.log('Using LIFF ID from URL:', urlLiffId);
          return urlLiffId;
        }

        // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å server API
        const response = await fetch('/api/liff/config', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const config = await response.json();
        console.log('LIFF config from server:', config);
        return config.liffId;
      } catch (error) {
        console.error('Error getting LIFF config:', error);
        // ‡πÅ‡∏™‡∏î‡∏á error ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á LIFF ID: ${error.message}`;
        return null;
      }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á debug info
    function showDebugInfo(info) {
      console.log('Debug info:', info);
      const debugElement = document.getElementById('debugInfo');
      if (debugElement) {
        debugElement.innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
      }
    }

    async function main() {
      try {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug
        showDebugInfo({
          userAgent: navigator.userAgent,
          url: window.location.href,
          isInClient: typeof liff !== 'undefined'
        });

        // ‡∏î‡∏∂‡∏á LIFF ID
        const liffId = await getLiffConfig();
        
        if (!liffId) {
          throw new Error('LIFF ID not configured or not available');
        }

        console.log('Initializing LIFF with ID:', liffId);

        // Initialize LIFF
        await liff.init({ liffId: liffId });

        console.log('LIFF initialization successful');
        showDebugInfo({
          liffId: liffId,
          isLoggedIn: liff.isLoggedIn(),
          isInClient: liff.isInClient(),
          isApiAvailable: liff.isApiAvailable('shareTargetPicker')
        });

        if (!liff.isLoggedIn()) {
          console.log('User not logged in, redirecting to login');
          liff.login();
          return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ shareTargetPicker API ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!liff.isApiAvailable('shareTargetPicker')) {
          throw new Error('Share Target Picker API is not available in this context');
        }

        // Get referral code from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const referralCode = urlParams.get('code') || 'DEMO123';
        
        // Display referral code
        document.getElementById('referralCode').textContent = referralCode;
        
        // Enable share button
        const shareBtn = document.getElementById('shareBtn');
        shareBtn.disabled = false;

        shareBtn.onclick = async () => {
          try {
            console.log('Share button clicked');
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            shareBtn.disabled = true;
            
            // Hide previous messages
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ß‡πà‡∏≤ API ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            if (!liff.isApiAvailable('shareTargetPicker')) {
              throw new Error('Share Target Picker API is not available');
            }

            // Create share card
            const shareCard = createReferralShareCard(referralCode);
            console.log('Share card created:', shareCard);
            
            // Share using Share Target Picker
            console.log('Calling liff.shareTargetPicker...');
            const result = await liff.shareTargetPicker([shareCard]);
            console.log('Share result:', result);
            
            // Show success
            document.getElementById('loading').style.display = 'none';
            document.getElementById('successMessage').style.display = 'block';
            
            showDebugInfo({
              action: 'share_success',
              result: result,
              timestamp: new Date().toISOString()
            });
            
            // Auto close after 2 seconds
            setTimeout(() => {
              if (liff.isInClient()) {
                liff.closeWindow();
              }
            }, 2000);
            
          } catch (err) {
            console.error('Share error:', err);
            
            // Show error with details
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = `‚ùå ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`;
            shareBtn.disabled = false;
            
            showDebugInfo({
              action: 'share_error',
              error: {
                message: err.message,
                stack: err.stack,
                name: err.name
              },
              liffContext: {
                isInClient: liff.isInClient(),
                isLoggedIn: liff.isLoggedIn(),
                isApiAvailable: liff.isApiAvailable('shareTargetPicker')
              },
              timestamp: new Date().toISOString()
            });
          }
        };

      } catch (error) {
        console.error('LIFF initialization failed:', error);
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${error.message}`;
        
        showDebugInfo({
          action: 'liff_init_error',
          error: {
            message: error.message,
            stack: error.stack,
            name: error.name
          },
          userAgent: navigator.userAgent,
          url: window.location.href,
          timestamp: new Date().toISOString()
        });
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô debug info
    function toggleDebug() {
      const debugElement = document.getElementById('debugInfo');
      debugElement.classList.toggle('show-debug');
    }

    function createReferralShareCard(referralCode) {
      return {
        type: "flex",
        altText: `üéÅ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ! ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™ ${referralCode}`,
        contents: {
          type: "bubble",
          header: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    type: "text",
                    text: "üéÅ",
                    size: "xl",
                    color: "#ffffff",
                    flex: 0
                  },
                  {
                    type: "text",
                    text: "‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ!",
                    weight: "bold",
                    color: "#ffffff",
                    size: "lg",
                    flex: 4,
                    margin: "md"
                  }
                ]
              },
              {
                type: "text",
                text: "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏ó‡∏ô‡∏µ‡πâ",
                color: "#ffffff",
                size: "sm",
                align: "center",
                margin: "md"
              }
            ],
            backgroundColor: "#722ed1",
            paddingAll: "20px"
          },
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              // ‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: "üî• ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©",
                    weight: "bold",
                    size: "md",
                    color: "#722ed1",
                    align: "center"
                  },
                  {
                    type: "text",
                    text: referralCode,
                    weight: "bold",
                    size: "xxl",
                    color: "#722ed1",
                    align: "center",
                    margin: "sm",
                    decoration: "none"
                  },
                  {
                    type: "text",
                    text: "‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏£‡∏´‡∏±‡∏™:" + referralCode,
                    size: "sm",
                    color: "#49aa19",
                    align: "center",
                    margin: "sm",
                    weight: "bold"
                  }
                ],
                spacing: "sm",
                margin: "lg",
                action: {
                  type: "clipboard",
                  clipboardText: "‡∏£‡∏´‡∏±‡∏™:" + referralCode
                }
              },
              {
                type: "separator",
                margin: "xl",
                color: "#303030"
              },
              // ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: "üéØ ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:",
                    weight: "bold",
                    color: "#ffffff",
                    size: "sm"
                  },
                  {
                    type: "text",
                    text: "‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ 5 ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ\n‚úÖ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ 10 ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï\n‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ AI\n‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö AI-Auto Forex",
                    color: "#8c8c8c",
                    size: "xs",
                    wrap: true,
                    margin: "sm"
                  }
                ],
                margin: "lg"
              },
              {
                type: "separator",
                margin: "xl",
                color: "#303030"
              },
              // ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: "üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™:",
                    weight: "bold",
                    color: "#ffffff",
                    size: "sm"
                  },
                  {
                    type: "text",
                    text: "1Ô∏è‚É£ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° \"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô\" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á\n2Ô∏è‚É£ ‡∏û‡∏¥‡∏°‡∏û‡πå \"‡∏£‡∏´‡∏±‡∏™:" + referralCode + "\"\n3Ô∏è‚É£ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!",
                    color: "#8c8c8c",
                    size: "xs",
                    wrap: true,
                    margin: "sm"
                  }
                ],
                margin: "lg"
              }
            ],
            spacing: "sm",
            paddingAll: "20px",
            backgroundColor: "#1f1f1f"
          },
          footer: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "button",
                style: "primary",
                action: {
                  type: "uri",
                  label: "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
                  uri: "https://line.me/R/ti/p/@033mebpp"
                },
                color: "#722ed1",
                height: "md"
              },
              {
                type: "text",
                text: "‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß",
                color: "#d89614",
                size: "xs",
                align: "center",
                margin: "sm"
              }
            ],
            spacing: "sm",
            paddingAll: "20px",
            backgroundColor: "#1f1f1f"
          }
        }
      };
    }

    main();
  </script>
</body>
</html>