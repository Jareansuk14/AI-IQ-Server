// AI-Server/services/iqOptionService.js - Simplified Version
const axios = require('axios');
require('dotenv').config();

class IQOptionService {
  constructor() {
    this.baseURL = 'https://api.twelvedata.com';
    this.apiKey = process.env.TWELVE_DATA_API_KEY;
    this.timeout = 30000; // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    this.requestCount = 0; // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
    this.dailyLimit = 800; // Free plan limit
  }

  // üéØ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏π‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢)
  async getCurrentCandle(pair) {
    try {
      console.log(`üîç Getting current candle for ${pair}`);

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key
      if (!this.apiKey) {
        throw new Error('‚ùå TWELVE_DATA_API_KEY ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô .env file');
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö daily limit
      if (this.requestCount >= this.dailyLimit) {
        throw new Error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (800 requests/day)');
      }

      // ‡πÅ‡∏õ‡∏•‡∏á pair ‡πÄ‡∏õ‡πá‡∏ô Twelve Data symbol
      const twelveSymbol = this.convertToTwelveDataSymbol(pair);
      console.log(`üìä Twelve Data symbol: ${twelveSymbol}`);

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const candleData = await this.getLatestCandle(twelveSymbol);
      
      if (!candleData) {
        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ');
      }

      // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏µ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô
      const { open, close, datetime, high, low, volume } = candleData;
      
      console.log(`üìä Open: ${open}, Close: ${close}`);

      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô
      let color;
      if (close > open) {
        color = "green";  // ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô)
      } else if (close < open) {
        color = "red";    // ‡πÅ‡∏ó‡πà‡∏á‡πÅ‡∏î‡∏á (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏á)
      } else {
        color = "doji";   // ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
      }

      console.log(`üéØ Candle color: ${color}`);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
      const candleTime = new Date(datetime);
      const displayTime = candleTime.toLocaleTimeString('th-TH', { 
        hour: '2-digit', 
        minute: '2-digit',
        timeZone: 'Asia/Bangkok'
      });

      const result = {
        pair: pair,
        symbol: twelveSymbol,
        time: displayTime,
        datetime: datetime,
        candleSize: "5min",
        open: parseFloat(open),
        close: parseFloat(close),
        high: parseFloat(high),
        low: parseFloat(low),
        volume: parseFloat(volume) || 0,
        color: color,
        source: "Twelve Data API",
        requestCount: this.requestCount,
        timestamp: new Date().toISOString()
      };

      console.log(`‚úÖ Current candle result:`, result);
      return result;

    } catch (error) {
      console.error(`‚ùå Error getting current candle: ${error.message}`);
      return {
        error: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: ${error.message}`,
        pair: pair,
        timestamp: new Date().toISOString()
      };
    }
  }

  // üåê ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Twelve Data
  async getLatestCandle(twelveSymbol) {
    try {
      const url = `${this.baseURL}/time_series`;
      
      const params = {
        symbol: twelveSymbol,
        interval: '5min',
        apikey: this.apiKey,
        outputsize: 2, // ‡∏î‡∏∂‡∏á‡πÅ‡∏Ñ‡πà 2 ‡πÅ‡∏ó‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
        format: 'JSON'
      };

      console.log(`üîó Fetching latest candle: ${url}`);
      console.log(`üìä Params:`, params);

      const response = await axios.get(url, {
        params,
        timeout: this.timeout,
        headers: {
          'User-Agent': 'Mozilla/5.0 (compatible; TradingBot/1.0)',
          'Accept': 'application/json'
        }
      });

      // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
      this.requestCount++;
      console.log(`üìà API Request count: ${this.requestCount}/${this.dailyLimit}`);

      const data = response.data;
      
      if (data.status === 'error') {
        throw new Error(`Twelve Data API Error: ${data.message}`);
      }

      if (!data.values || data.values.length === 0) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô Twelve Data');
      }

      console.log(`üìä Got ${data.values.length} candles from Twelve Data`);

      // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (index 0 ‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î)
      const latestCandle = data.values[0];

      return {
        datetime: latestCandle.datetime,
        open: latestCandle.open,
        close: latestCandle.close,
        high: latestCandle.high,
        low: latestCandle.low,
        volume: latestCandle.volume
      };

    } catch (error) {
      console.error(`‚ùå Twelve Data API error: ${error.message}`);
      
      if (error.response) {
        console.error(`‚ùå Response status: ${error.response.status}`);
        console.error(`‚ùå Response data:`, error.response.data);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö error ‡∏à‡∏≤‡∏Å API
        if (error.response.data?.message?.includes('API key')) {
          throw new Error('API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏');
        }
        if (error.response.data?.message?.includes('limit')) {
          throw new Error('‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API');
        }
      }
      
      throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Twelve Data ‡πÑ‡∏î‡πâ: ${error.message}`);
    }
  }

  // üîÑ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility)
  async getCandleColor(pair, entryTime, round) {
    try {
      console.log(`üîÑ Legacy function called: ${pair}, ${entryTime}, round ${round}`);
      console.log(`‚ö†Ô∏è Using simplified getCurrentCandle() instead`);
      
      // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô
      const result = await this.getCurrentCandle(pair);
      
      if (result.error) {
        return {
          error: result.error,
          pair: pair,
          entryTime: entryTime,
          round: round
        };
      }

      // ‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
      return {
        pair: result.pair,
        time: result.time,
        candleSize: result.candleSize,
        open: result.open,
        close: result.close,
        color: result.color,
        round: round,
        entryTime: entryTime,
        actualDateTime: result.datetime,
        volume: result.volume,
        source: result.source,
        timestamp: result.timestamp
      };

    } catch (error) {
      console.error(`‚ùå Error in legacy getCandleColor: ${error.message}`);
      return {
        error: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: ${error.message}`,
        pair: pair,
        entryTime: entryTime,
        round: round
      };
    }
  }

  // üîÑ ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô Twelve Data symbol (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  convertToTwelveDataSymbol(pair) {
    const symbolMap = {
      // Forex pairs
      'EUR/USD': 'EUR/USD',
      'EURUSD': 'EUR/USD',
      'GBP/USD': 'GBP/USD',
      'GBPUSD': 'GBP/USD',
      'USD/JPY': 'USD/JPY',
      'USDJPY': 'USD/JPY',
      'USD/CHF': 'USD/CHF',
      'USDCHF': 'USD/CHF',
      'AUD/USD': 'AUD/USD',
      'AUDUSD': 'AUD/USD',
      'NZD/USD': 'NZD/USD',
      'NZDUSD': 'NZD/USD',
      'USD/CAD': 'USD/CAD',
      'USDCAD': 'USD/CAD',
      'EUR/GBP': 'EUR/GBP',
      'EURGBP': 'EUR/GBP',
      'EUR/JPY': 'EUR/JPY',
      'EURJPY': 'EUR/JPY',
      'GBP/JPY': 'GBP/JPY',
      'GBPJPY': 'GBP/JPY',
      
      // Crypto pairs
      'BTC/USD': 'BTC/USD',
      'BTCUSD': 'BTC/USD',
      'ETH/USD': 'ETH/USD',
      'ETHUSD': 'ETH/USD',
      'LTC/USD': 'LTC/USD',
      'LTCUSD': 'LTC/USD',
      'ADA/USD': 'ADA/USD',
      'ADAUSD': 'ADA/USD',
      
      // Commodities
      'GOLD': 'XAU/USD',
      'XAUUSD': 'XAU/USD'
    };
    
    return symbolMap[pair] || 'EUR/USD';
  }

  // üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢)
  async testConnection() {
    try {
      console.log('üß™ Testing Twelve Data API connection...');
      
      if (!this.apiKey) {
        return {
          success: false,
          error: 'TWELVE_DATA_API_KEY ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô .env file',
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° API Key ‡πÉ‡∏ô .env file',
          method: 'Twelve Data API (Simplified)'
        };
      }

      // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const testResult = await this.getCurrentCandle('EUR/USD');
      
      if (testResult.error) {
        return {
          success: false,
          error: testResult.error,
          message: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Twelve Data ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
          method: 'Twelve Data API (Simplified)',
          requestCount: this.requestCount
        };
      }

      return {
        success: true,
        message: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Twelve Data ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Simplified Version)',
        method: 'Twelve Data API - getCurrentCandle()',
        data: {
          pair: testResult.pair,
          time: testResult.time,
          color: testResult.color,
          price: testResult.close
        },
        requestCount: this.requestCount,
        remainingRequests: this.dailyLimit - this.requestCount
      };

    } catch (error) {
      console.error('‚ùå Connection test failed:', error);
      return {
        success: false,
        error: error.message,
        message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ',
        method: 'Twelve Data API (Simplified)',
        requestCount: this.requestCount
      };
    }
  }

  // üìä ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö testing)
  async getMultipleCandles(pair, entryTime, rounds) {
    const results = [];
    
    console.log(`üîç Testing with simplified method - Getting current candle ${rounds} times`);
    
    for (let round = 1; round <= rounds; round++) {
      try {
        console.log(`üìä Test ${round}/${rounds} - Request count: ${this.requestCount}/${this.dailyLimit}`);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö daily limit
        if (this.requestCount >= this.dailyLimit) {
          results.push({
            error: '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
            round,
            pair,
            entryTime,
            requestCount: this.requestCount
          });
          break;
        }
        
        // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà getCurrentCandle()
        const result = await this.getCurrentCandle(pair);
        result.round = round; // ‡πÄ‡∏û‡∏¥‡πà‡∏° round number
        result.entryTime = entryTime; // ‡πÄ‡∏û‡∏¥‡πà‡∏° entry time
        results.push(result);
        
        // ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
        if (round < rounds) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      } catch (error) {
        results.push({
          error: error.message,
          round,
          pair,
          entryTime,
          requestCount: this.requestCount
        });
      }
    }
    
    return results;
  }

  // üïê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  isMarketOpen() {
    const now = new Date();
    const day = now.getDay(); // 0 = Sunday, 6 = Saturday
    const hour = now.getHours();
    
    return {
      forex: day !== 0 && day !== 6,  // Forex ‡∏õ‡∏¥‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
      crypto: true,                   // Crypto ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏•‡∏≠‡∏î
      tradingHours: hour >= 9 && hour <= 17, // Trading hours 9-17
      timestamp: now.toISOString(),
      timezone: 'Asia/Bangkok'
    };
  }

  // üìà ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
  getUsageStats() {
    const remainingRequests = Math.max(0, this.dailyLimit - this.requestCount);
    const usagePercent = Math.round((this.requestCount / this.dailyLimit) * 100);

    return {
      method: 'Twelve Data API (Simplified)',
      mainFunction: 'getCurrentCandle()',
      dataSource: 'Twelve Data Financial API',
      apiEndpoint: this.baseURL,
      timeout: `${this.timeout / 1000} seconds`,
      apiKeyConfigured: !!this.apiKey,
      requestCount: this.requestCount,
      dailyLimit: this.dailyLimit,
      remainingRequests: remainingRequests,
      usagePercent: `${usagePercent}%`,
      marketStatus: this.isMarketOpen(),
      supportedPairs: [
        // Forex
        'EUR/USD', 'GBP/USD', 'USD/JPY', 'USD/CHF',
        'AUD/USD', 'NZD/USD', 'USD/CAD', 'EUR/GBP',
        'EUR/JPY', 'GBP/JPY',
        // Crypto  
        'BTC/USD', 'ETH/USD', 'LTC/USD', 'ADA/USD',
        // Commodities
        'XAU/USD (GOLD)'
      ],
      features: [
        '‚úÖ Simplified Logic',
        '‚úÖ Current Candle Only',
        '‚úÖ No Time Calculation',
        '‚úÖ 800 requests/day (Free plan)',
        '‚úÖ Real-time latest candle',
        '‚úÖ Easy to understand',
        '‚úÖ Rate limiting protection'
      ],
      advantages: [
        '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° 90%',
        '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤',
        '‡∏î‡∏π‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
        '‡∏•‡∏î complexity ‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å',
        '‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£ debug',
        '‡πÉ‡∏ä‡πâ API calls ‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á'
      ],
      pricing: {
        free: '800 requests/day',
        basic: '$8/month - 5,000 requests/day',
        standard: '$24/month - 15,000 requests/day'
      },
      lastChecked: new Date().toISOString()
    };
  }

  // üîß ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï request counter (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  resetDailyCounter() {
    this.requestCount = 0;
    console.log('üîÑ Daily request counter reset to 0');
  }

  // üí∞ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö quote ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  async getQuote(pair) {
    try {
      if (!this.apiKey) {
        throw new Error('TWELVE_DATA_API_KEY ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
      }

      const symbol = this.convertToTwelveDataSymbol(pair);
      const url = `${this.baseURL}/quote`;
      
      const params = {
        symbol: symbol,
        apikey: this.apiKey
      };

      const response = await axios.get(url, { params, timeout: this.timeout });
      this.requestCount++;

      const data = response.data;

      if (data.status === 'error') {
        throw new Error(data.message);
      }

      return {
        symbol: data.symbol,
        price: parseFloat(data.close),
        change: parseFloat(data.change),
        percent_change: data.percent_change,
        high: parseFloat(data.high),
        low: parseFloat(data.low),
        volume: parseFloat(data.volume) || 0,
        timestamp: data.datetime,
        source: 'Twelve Data',
        requestCount: this.requestCount
      };

    } catch (error) {
      console.error(`‚ùå Quote error: ${error.message}`);
      throw error;
    }
  }

  // üîß Helper method ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
  async debugCurrentCandle(pair) {
    try {
      console.log(`üîß Debug mode - Simplified getCurrentCandle()`);
      console.log(`üìä Pair: ${pair}`);
      console.log(`üîë API Key: ${this.apiKey ? 'Configured' : 'Not configured'}`);
      console.log(`üìà Request Count: ${this.requestCount}/${this.dailyLimit}`);

      const twelveSymbol = this.convertToTwelveDataSymbol(pair);
      console.log(`üåê Twelve Data Symbol: ${twelveSymbol}`);

      const result = await this.getCurrentCandle(pair);
      
      console.log(`üìä Final Result:`, JSON.stringify(result, null, 2));
      
      return result;
    } catch (error) {
      console.error('Debug error:', error);
      return { error: error.message };
    }
  }
}

module.exports = new IQOptionService();